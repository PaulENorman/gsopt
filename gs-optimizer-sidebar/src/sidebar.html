<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* Global box-sizing ensures padding doesn't affect width, fixing alignment issues */
      * { box-sizing: border-box; }
      
      body { 
        font-family: 'Roboto', sans-serif; 
        padding: 16px; 
        color: #202124; 
        background-color: #ffffff; 
        line-height: 1.5; 
        margin: 0;
      }
      
      .header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
      .logo-text { font-size: 1.5em; font-weight: 500; color: #1a73e8; margin: 0; }
      .doc-link { font-size: 0.8em; color: #5f6368; text-decoration: none; border: 1px solid #dadce0; padding: 4px 8px; border-radius: 4px; }
      .doc-link:hover { background-color: #f8f9fa; }
      
      h2 { 
        font-size: 0.9em; 
        font-weight: 500; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
        color: #5f6368; 
        margin: 24px 0 0 0; 
        padding-bottom: 8px; 
        border-bottom: 1px solid #e8eaed; 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
      }
      
      .triangle { display: inline-block; width: 0; height: 0; margin-right: 8px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #5f6368; transition: transform 0.2s; }
      .collapsed .triangle { transform: rotate(-90deg); }
      
      .section-content { 
        padding-top: 12px;
      }
      .collapsed .section-content { display: none; }
      
      .form-group { margin-bottom: 16px; }
      label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.85em; color: #3c4043; }
      
      /* Reduced height for dropdowns and inputs */
      select, input { 
        width: 100%; 
        padding: 8px 10px; 
        border: 1px solid #dadce0; 
        border-radius: 4px; 
        font-size: 0.9em; 
        transition: border-color 0.2s; 
        height: 36px;
        background-color: #ffffff;
      }
      select:focus, input:focus { border-color: #1a73e8; outline: none; box-shadow: 0 0 0 2px rgba(26,115,232,0.2); }
      
      /* CRITICAL: Override any external styles from add-ons1.css */
      button, 
      input[type="button"],
      input[type="submit"] { 
        width: 100% !important;
        height: 38px !important;
        margin: 0 0 10px 0 !important;
        padding: 0 16px !important;
        
        /* Reset any float, position, or display overrides */
        float: none !important;
        position: static !important;
        left: auto !important;
        right: auto !important;

        background: #1a73e8; 
        color: #ffffff; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        
        font-family: inherit;
        font-weight: 500; 
        font-size: 14px;
        text-align: center;
        line-height: 38px; /* Match height for vertical centering */

        transition: background 0.2s, box-shadow 0.2s; 
        box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15); 
      }
      
      button:hover { background: #1765cc !important; box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15) !important; }
      button:active { background: #1669bb !important; }
      button:disabled { background: #e8eaed !important; color: #9aa0a6 !important; cursor: not-allowed !important; box-shadow: none !important; }
      
      button.secondary { background: #ffffff !important; color: #1a73e8 !important; border: 1px solid #dadce0 !important; box-shadow: none !important; }
      button.secondary:hover { background: #f8f9fa !important; border-color: #d2e3fc !important; }
      
      #message { margin-top: 20px; padding: 12px; border-radius: 8px; font-size: 0.85em; display: none; }
      .footer { margin-top: 32px; text-align: center; font-size: 0.75em; color: #70757a; border-top: 1px solid #e8eaed; padding-top: 16px; }
      .footer a { color: #1a73e8; text-decoration: none; }

      .info-icon {
          display: inline-block;
          width: 14px;
          height: 14px;
          background: #e8eaed;
          color: #5f6368;
          border-radius: 50%;
          text-align: center;
          line-height: 14px;
          font-size: 10px;
          margin-left: 5px;
          cursor: help;
          vertical-align: middle;
      }

      .error { color: red; }
      .success { color: green; }
    </style>
  </head>
  <body>
    <div class="header-row">
        <h1 class="logo-text">GSOpt</h1>
        <a href="https://paulnorman.cc/gsopt/" target="_blank" class="doc-link" title="Open the full documentation">Docs</a>
    </div>

    <div id="settings-section" class="section">
        <h2 onclick="toggleSection('settings-section')">
            <span class="triangle"></span>Optimizer Settings <span class="info-icon" title="Configure the mathematical model and sampling behavior">?</span>
        </h2>
        <div class="section-content">
            <div class="form-group">
                <label>Base Estimator <span class="info-icon" title="The primary regression model used to approximate your data">?</span></label>
                <select id="base_estimator">
                    <option value="Gaussian Process (GP)">Gaussian Process (GP)</option>
                    <option value="Random Forrest (RF)">Random Forrest (RF)</option>
                    <option value="Extra Trees (ET)">Extra Trees (ET)</option>
                    <option value="Gradient Boosted Regression Trees (GBRT)">Gradient Boosted Regression Trees (GBRT)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Acquisition Function <span class="info-icon" title="The logic used to choose the next most promising points">?</span></label>
                <select id="acquisition_function" onchange="toggleKappa()">
                    <option value="Expected Improvement (EI)">Expected Improvement (EI)</option>
                    <option value="Probability of Improvement (PI)">Probability of Improvement (PI)</option>
                    <option value="Lower Confidence Bound (LCB)">Lower Confidence Bound (LCB)</option>
                    <option value="Hedge (gp_hedge)">Hedge (gp_hedge)</option>
                </select>
            </div>
            <div class="form-group" id="kappa-group" style="display:none;">
                <label>Kappa (LCB Only) <span class="info-icon" title="Controls exploration vs exploitation. Low kappa (e.g., 0.1) exploits known good areas; high kappa (e.g., 5.0) explores uncertainty.">?</span></label>
                <input type="number" id="acq_func_kappa" value="1.96" step="0.1" min="0">
            </div>
            <div class="form-group">
                <label>Number of Initial Points <span class="info-icon" title="Number of random points to sample before the model takes control">?</span></label>
                <input type="number" id="num_init_points" value="10" min="1">
            </div>
            <div class="form-group">
                <label>Batch Size <span class="info-icon" title="How many new suggestions to generate per request">?</span></label>
                <input type="number" id="batch_size" value="5" min="1">
            </div>
            <div class="form-group">
                <label>Optimization Mode <span class="info-icon" title="Choose whether the goal is to find the smallest or largest value">?</span></label>
                <select id="optimization_mode">
                    <option value="Minimize">Minimize</option>
                    <option value="Maximize">Maximize</option>
                </select>
            </div>
        </div>
    </div>

    <div id="controls-section" class="section">
        <h2 onclick="toggleSection('controls-section')">
            <span class="triangle"></span>Optimizer Controls <span class="info-icon" title="Actions to run the optimizer and check the backend">?</span>
        </h2>
        <div class="section-content">
            <button id="btnInit" onclick="askForInitPoints()" title="Clear existing data and generate initial points using Latin Hypercube Sampling">Initialize</button>
            <button id="btnContinue" onclick="tellAsk()" title="Analyze evaluated data and generate new suggestions">Ask</button>
            <button id="btnTest" class="secondary" onclick="testConnection()" title="Verify that the optimizer server is reachable">Test Connection</button>
        </div>
    </div>

    <div id="plots-section" class="section">
        <h2 onclick="toggleSection('plots-section')">
            <span class="triangle"></span>Data Plots <span class="info-icon" title="Advanced multi-dimensional data visualization">?</span>
        </h2>
        <div class="section-content">
            <button onclick="google.script.run.openConvergencePlot()" title="View how the objective improved over iterations">Convergence</button>
            <button onclick="google.script.run.openEvaluationsPlot()" title="View the order and distribution of sampled points">Evaluations</button>
            <button onclick="google.script.run.openObjectivePlot()" title="Objective Partial Dependence">Partial Dependence</button>
            <button onclick="openParallelCoords()" title="Open an interactive multi-axis view of all parameters">Parallel Coordinates</button>
        </div>
    </div>

    <div id="message"></div>

    <div class="footer">
        Build: <a href="https://github.com/PaulENorman/gsopt" target="_blank">View on GitHub</a>
    </div>

    <script>
        // ========================================
        // THROTTLING & DEBOUNCING UTILITIES
        // ========================================
        
        let pingDebounceTimer = null;
        let lastPingTime = 0;
        const PING_DEBOUNCE_MS = 500;  // Mouse activity debounce
        const PING_MIN_INTERVAL_MS = 3000;  // Minimum time between actual pings
        let isPinging = false;
        
        /**
         * Debounced server ping to warm up Cloud Run instance.
         * Triggered by mouse activity but throttled to prevent spam.
         */
        function debouncedServerPing() {
            // Clear existing timer
            if (pingDebounceTimer) {
                clearTimeout(pingDebounceTimer);
            }
            
            // Set new debounce timer
            pingDebounceTimer = setTimeout(() => {
                const now = Date.now();
                
                // Check if enough time has passed since last ping
                if (now - lastPingTime < PING_MIN_INTERVAL_MS) {
                    return;
                }
                
                // Avoid concurrent pings
                if (isPinging) {
                    return;
                }
                
                isPinging = true;
                lastPingTime = now;
                
                google.script.run
                    .withSuccessHandler(() => {
                        isPinging = false;
                        console.log('Server ping successful');
                    })
                    .withFailureHandler((err) => {
                        isPinging = false;
                        console.log('Server ping failed:', err);
                    })
                    .pingServer();
            }, PING_DEBOUNCE_MS);
        }
        
        /**
         * Attach mouse activity listeners for proactive server wake-up
         */
        function attachActivityListeners() {
            // Listen for mouse movement over interactive elements
            const interactiveElements = document.querySelectorAll('button, select, input');
            
            interactiveElements.forEach(element => {
                element.addEventListener('mouseenter', debouncedServerPing);
            });
            
            // Also ping when sidebar becomes visible/active
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    debouncedServerPing();
                }
            });
        }
        
        // ========================================
        // EXISTING FUNCTIONS
        // ========================================
        
        function toggleSection(id) {
            document.getElementById(id).classList.toggle('collapsed');
        }

        function toggleKappa() {
            const select = document.getElementById('acquisition_function');
            const kappaGroup = document.getElementById('kappa-group');
            if (select.value.indexOf('LCB') !== -1) {
                kappaGroup.style.display = 'block';
            } else {
                kappaGroup.style.display = 'none';
            }
        }

        window.onload = function() {
            google.script.run
                .withSuccessHandler(populateSettings)
                .getInitialSettings();
            
            // Attach activity listeners for proactive pinging
            attachActivityListeners();
            
            // Initial ping on sidebar load
            debouncedServerPing();
        };

        function populateSettings(s) {
            if (!s) return;
            setSelectByValueFragment('base_estimator', s.base_estimator);
            setSelectByValueFragment('acquisition_function', s.acquisition_function);
            
            const nParams = s.num_params || 1;
            document.getElementById('num_init_points').value = nParams * 10;
            document.getElementById('batch_size').value = nParams * 5;
            
            document.getElementById('optimization_mode').value = s.optimization_mode || 'Minimize';
            
            if (s.acq_func_kwargs && s.acq_func_kwargs.kappa) {
                document.getElementById('acq_func_kappa').value = s.acq_func_kwargs.kappa;
            }
            toggleKappa();
        }

        function setSelectByValueFragment(id, fragment) {
            const el = document.getElementById(id);
            for (let i = 0; i < el.options.length; i++) {
                if (el.options[i].value.indexOf('(' + fragment + ')') !== -1 || el.options[i].value === fragment) {
                    el.selectedIndex = i;
                    break;
                }
            }
        }

        function collectSettings() {
            const acqFunc = document.getElementById('acquisition_function').value;
            const settings = {
                base_estimator: document.getElementById('base_estimator').value,
                acquisition_function: acqFunc,
                num_init_points: parseInt(document.getElementById('num_init_points').value),
                batch_size: parseInt(document.getElementById('batch_size').value),
                optimization_mode: document.getElementById('optimization_mode').value,
                acq_func_kwargs: {}
            };
            
            if (acqFunc.indexOf('LCB') !== -1) {
                settings.acq_func_kwargs['kappa'] = parseFloat(document.getElementById('acq_func_kappa').value);
            }
            
            return settings;
        }

        function askForInitPoints() {
            const settings = collectSettings();
            setLoading(true);
            
            // Ping server before heavy operation
            google.script.run.pingServer();
            
            google.script.run
                .withSuccessHandler(r => { setLoading(false); showMessage(r); })
                .withFailureHandler(err => { setLoading(false); showMessage({status: 'error', message: err}); })
                .ask_for_init_points(settings);
        }

        function tellAsk() {
            const settings = collectSettings();
            setLoading(true);
            
            // Ping server before heavy operation
            google.script.run.pingServer();
            
            google.script.run
                .withSuccessHandler(r => { setLoading(false); showMessage(r); })
                .withFailureHandler(err => { setLoading(false); showMessage({status: 'error', message: err}); })
                .tell_ask(settings);
        }

        function testConnection() {
            setLoading(true);
            google.script.run
                .withSuccessHandler(r => { setLoading(false); showMessage(r); })
                .withFailureHandler(err => { setLoading(false); showMessage({status: 'error', message: err}); })
                .testCloudRunConnection();
        }

        function openParallelCoords() {
            google.script.run.openParallelCoordinates();
        }

        function showMessage(response) {
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'block';
            messageDiv.textContent = response.message || 'Operation completed.';
            messageDiv.style.backgroundColor = response.status === 'error' ? '#fde8e8' : '#eafaf1';
            messageDiv.style.color = response.status === 'error' ? '#c81e1e' : '#1e7e34';
            messageDiv.style.border = `1px solid ${response.status === 'error' ? '#f8b4b4' : '#b7e4c7'}`;
        }

        function setLoading(isLoading) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(b => b.disabled = isLoading);
            if (isLoading) {
                const messageDiv = document.getElementById('message');
                messageDiv.style.display = 'block';
                messageDiv.textContent = 'Processing... Please wait.';
                messageDiv.style.backgroundColor = '#e1effe';
                messageDiv.style.color = '#1e429f';
                messageDiv.style.border = '1px solid #a4cafe';
            }
        }
    </script>
  </body>
</html>